# 服の色合わせアプリ 仕様書（更新版）

## 0. 前提 / 用語
- **コーデ**: 服装の上下・アウター・シューズ・小物の組み合わせ。
- **近似色**: 指定色に色相・明度・彩度が近い色。
- **相性色**: 視覚的に調和しやすい組み合わせとして提示する色。
- **シルエット化**: 人物や服の輪郭を抽出し、細部を簡略化したイラスト表現。
- **色表現**: 入力・出力は`#RRGGBB`（sRGB）。内部計算はHSVまたはCIELABを使用。

## 1. 目的 / コンセプト
- 服の色合わせに悩むユーザーへ、人気コーデから抽出した配色知見をベースに「探しやすく・わかりやすい」色合わせ体験を提供する。
- メイン利用はiPhone（スマホUI最適化）、PCは補助的に対応。

## 2. 対象ユーザー / ペルソナ
- 色合わせに自信がない一般ユーザー（10代後半〜40代）
- 人気コーデや配色のトレンドを参考にしたいユーザー
- パーソナルカラーを学びたいが専門用語に詳しくないユーザー

## 3. スコープ
### 3.1 対象範囲
- イラスト化されたコーデ画像の検索・推薦
- 色検索（近似色・相性色提示）
- カテゴリ検索（アウター/トップス/ボトムス/シューズ/小物）

### 3.2 非対象範囲
- EC購入導線、在庫/価格連携
- ユーザー投稿・SNS機能
- 課金・サブスク機能
- 16タイプ診断の本実装（将来候補）

## 4. 主要機能要件

### 機能1：人気コーデ自動収集・登録（イラスト化運用）
**概要**
- 外部コーデ投稿サイトから画像/情報を収集し、いいね数が多いものを「良い色合わせ」として登録。
- 画像はそのまま使用せず、**人物・服・小物を含めてシルエット化**し、**抽出色を保持**したイメージイラストとして利用。

**入力**
- 外部コーデ投稿サイトの公開情報（画像URL、いいね数、タグ、カテゴリなど）

**処理フロー**
1. 外部サイトから画像取得
2. 主要色抽出
3. **人物・服・小物を含めたシルエット化**（色は抽出色を保持）
4. イラスト画像＋色情報をDB登録

**出力**
- アプリ内データベースに「高評価コーデ」として保存

**例外 / 失敗**
- 取得失敗時はリトライ（最大3回）し、失敗ログに記録
- 色抽出が不安定な画像は「要確認」フラグで保留

**留意事項**
- 収集対象サイトの利用規約を事前に確認
- 著作権保護のため元画像は配信しない

**受け入れ条件**
- 収集件数・失敗件数・処理時間が管理画面に表示される
- 公開画面にはイラスト画像のみが表示される

---

### 機能2：色指定検索＋近似色 / 相性提示
**概要**
- 色を指定して検索すると、近い色と相性の良い色を提示。
- 関連するコーデ（機能1のイラスト画像）を表示。

**入力**
- 色指定（カラーコード/カラーピッカー）
- 任意: 季節、カテゴリ、テイスト

**出力**
- 近似色一覧
- 相性の良い色一覧
- 関連コーデ画像

**受け入れ条件**
- 近似色は色距離で上位N件を表示
- 相性色は固定リスト + スコア補正で提示

---

### 機能3：カテゴリ別おすすめコーデ提示
**概要**
- アウター、トップスなどの細かいジャンル選択に応じておすすめコーデを提示。

**入力**
- カテゴリ選択（アウター/トップス/ボトムス/シューズ/小物）

**出力**
- 該当カテゴリのおすすめコーデ

---

### 機能4：16タイプカラー診断（保留）
**方針**
- 無料で利用できるAPIが限定的なため、現時点では機能実装は保留。
- 将来的に「端末内判定」または「自己診断補助」型で再検討する。

---

### 機能5：管理画面（最小要件）
**概要**
- 収集実行、登録内容の確認・補正、失敗ログの確認を行う。

**入力**
- 収集対象URL / 収集条件 / カテゴリ補正

**出力**
- 収集ジョブの進行状況、成功/失敗件数
- 登録済みコーデの一覧と編集画面

---

### 機能6：保存 / 履歴（将来候補）
- お気に入り保存、閲覧履歴、後で見る機能

## 5. 画像処理 / 色抽出仕様
### 5.1 前処理
- 背景除去（人物と衣服・小物の分離を強調）
- 画像のトリミングと正規化（縦長比率）

### 5.2 ポスタライズ
- 色数を4〜8色に減色し、配色の要点を残す
- アウター/トップス/ボトムス/小物の主色を維持

### 5.3 輪郭強調
- エッジ抽出でシルエットを明瞭化
- 線の太さは縮小表示でも判読可能な太さに固定

### 5.4 色抽出ルール
- 優先度: アウター > トップス > ボトムス > 小物
- 明度差が小さい色は統合して「近似色」として扱う
- 画像内の面積比率を保持し、配色比率として保存

### 5.5 アルゴリズム方針
- MVPはヒストグラム法で簡易実装
- 精度向上フェーズでK-meansに切り替え

## 6. 色相性データ 初期リスト（案）
> ベースカラーを指定したときの「相性の良い色」候補例

### 6.1 ニュートラル系
- **ブラック** → ホワイト、グレー、ベージュ、キャメル、レッド
- **ホワイト** → ブラック、ネイビー、グレー、ベージュ、ブルー
- **グレー** → ホワイト、ブラック、ネイビー、ピンク、ブルー
- **ネイビー** → ホワイト、グレー、ベージュ、ライトブルー、ボルドー
- **ベージュ** → ホワイト、ブラウン、ネイビー、オリーブ、ブラック

### 6.2 暖色系
- **レッド** → ブラック、ホワイト、ネイビー、グレー、デニムブルー
- **オレンジ** → ホワイト、ベージュ、ネイビー、ブラウン、オリーブ
- **イエロー** → ホワイト、ネイビー、グレー、デニムブルー、カーキ
- **ピンク** → グレー、ホワイト、ネイビー、ベージュ、ブラウン

### 6.3 寒色系
- **ブルー** → ホワイト、グレー、ネイビー、ベージュ、キャメル
- **ライトブルー** → ホワイト、ネイビー、グレー、ベージュ
- **グリーン** → ホワイト、ベージュ、ブラック、ブラウン、ネイビー
- **オリーブ** → ベージュ、ホワイト、ブラック、ブラウン、カーキ
- **パープル** → ホワイト、ブラック、グレー、ベージュ

### 6.4 アクセント系
- **ボルドー** → ホワイト、ブラック、グレー、ネイビー
- **マスタード** → ネイビー、ホワイト、グレー、ブラウン
- **ターコイズ** → ホワイト、ベージュ、ネイビー

## 7. 検索 / 推薦ロジック
### 7.1 近似色検索
- 色距離はCIELABのΔEを優先。MVPはHSV距離でも可
- 距離上位N件（初期値: 5件）を近似色として提示

### 7.2 相性色提示
- 初期は固定リスト + スコア補正で提示
- スコアは「いいね数/保存数/滞在時間」を正規化して反映

### 7.3 コーデ表示
- 関連コーデは「指定色がパレット内に含まれる順」で並べ替え
- 結果0件時は「近似色を使ったコーデ」を提示

### 7.4 近似色の判定基準（初期値）
- ΔE2000（CIELAB）を採用
- 近似色の候補は`ΔE <= 12`を優先し、上限N件（初期値: 5件）
- `ΔE <= 6`は「かなり近い色」として上位固定
- 候補が不足する場合のみHSV距離で補完

### 7.5 相性色のスコア算出（初期式）
- 固定リストの組み合わせを`base_score = 1.0`とする
- 追加スコア: `0.6 * like_norm + 0.3 * save_norm + 0.1 * dwell_norm`
- 正規化は期間内（30日）の最大値で割る

## 8. データモデル（最低限）
### 8.1 コーデ
- `id` (string)
- `illustration_url` (string)
- `palette` (array: `{hex, ratio, role}`)
- `categories` (array: category_id)
- `likes` (int)
- `source` (string)
- `created_at` / `processed_at` (datetime)
- `status` (active / pending / rejected)

### 8.2 色ペア
- `base_hex` (string)
- `match_hex` (string)
- `score` (float)
- `season_tag` (string, optional)
- `updated_at` (datetime)

### 8.3 カテゴリ
- `id` (string)
- `name` (string)
- `parent_id` (string, nullable)
- `sort_order` (int)

### 8.4 ジョブ
- `id` (string)
- `type` (ingest / reprocess)
- `status` (queued / running / success / fail)
- `counts` (object: success, fail, skipped)
- `started_at` / `finished_at` (datetime)

## 9. API / バックエンド要件（最小）
### 9.1 参照系
- `GET /api/codes`（人気コーデ一覧、ソート/期間指定）
- `GET /api/codes/{id}`（コーデ詳細）
- `GET /api/colors/search?hex=`（色検索）
- `GET /api/categories`（カテゴリ一覧）
- `GET /api/categories/{id}/codes`（カテゴリ別コーデ）

### 9.2 管理系（認証必須）
- `POST /api/admin/ingest`（収集実行）
- `PATCH /api/admin/codes/{id}`（色・カテゴリ補正）
- `GET /api/admin/jobs`（ジョブ状況）
- `GET /api/admin/errors`（失敗ログ）

### 9.3 認証 / 認可（初期方針）
- 管理系は`Authorization: Bearer <token>`で保護
- MVPは固定トークン（環境変数）で運用し、運用移行時にJWTへ拡張
- 管理画面はIP制限（社内/自宅回線）を推奨

## 10. 画面 / UX要件（iPhone優先）
### 10.1 主要画面
- **ホーム**: 人気コーデ抜粋、色検索/カテゴリ検索導線
- **色検索**: カラーピッカー/コード入力、近似色・相性色、コーデ一覧
- **カテゴリ検索**: 大分類/小分類の選択、絞り込み、コーデ一覧
- **コーデ詳細**: 配色構成、相性色、類似コーデ導線
- **管理画面（内部）**: 収集実行、登録内容の確認・補正、失敗ログ

### 10.2 UI指針
- 片手操作を意識した下部ナビゲーション
- 画像は縦長比率を優先（iPhone表示最適化）
- 重要情報（色・カテゴリ・相性）をカード内に集約
- 色覚多様性に配慮し、色名/パターン表示を併記

### 10.3 エンプティ / エラー
- 結果0件時は近似色の提案を表示
- 通信失敗時は再試行導線を明示

### 10.4 テキストワイヤーフレーム（MVP）
```text
[Home]
--------------------------------------------------+
| Logo                          [Search Icon]     |
| [Color Search CTA] [Category Search CTA]        |
| Popular Codes (card grid, 2 columns)            |
|  - [Card] [Card]                                |
|  - [Card] [Card]                                |
+-------------------------------------------------+

[Color Search]
+-------------------------------------------------+
| < Back | Color Picker | #RRGGBB                 |
| Near Colors: [chip][chip][chip][chip][chip]     |
| Match Colors: [chip][chip][chip][chip]          |
| Related Codes (card grid)                       |
+-------------------------------------------------+

[Category Search]
+-------------------------------------------------+
| < Back | Category Tabs                          |
| [Outer][Tops][Bottoms][Shoes][Accessories]      |
| Subcategory chips                               |
| Related Codes (card grid)                       |
+-------------------------------------------------+

[Code Detail]
+-------------------------------------------------+
| < Back | Code Image (illustration)              |
| Palette chips + ratio                           |
| Match Colors                                    |
| Similar Codes (horizontal list)                 |
+-------------------------------------------------+
```

## 11. 非機能要件
- **パフォーマンス**: 一覧初期表示は3秒以内
- **可用性**: 手動更新時の停止時間を最小化
- **拡張性**: コーデ件数増加でも検索が劣化しない設計
- **セキュリティ**: 管理APIはトークン認証、権限分離
- **プライバシー**: 元画像は配信しない、保持期限を明確化
- **アクセシビリティ**: 色名表示、コントラスト基準の遵守

## 12. データフロー（概略）
1. 画像収集（外部サイト）
2. 主要色抽出
3. シルエット化・イラスト化
4. カテゴリ推定 or 手動タグ付け
5. DB登録
6. ユーザー検索・推薦に反映

## 13. 運用・管理
- **更新頻度**: 不定期・手動更新（必要なタイミングで管理画面から実行）
- **補正ルール**: 色抽出ミスは管理画面で修正
- **再処理**: 画像処理アルゴリズム更新時に一括再処理

### 13.1 運用フロー（MVP）
1. 管理画面から収集実行
2. 収集結果の件数・失敗理由を確認
3. 「要確認」フラグのコーデを補正
4. 公開反映（activeへ切り替え）

### 13.2 リリース前チェック
- 近似色/相性の提示が全カテゴリで成立するか確認
- 画像一覧の表示崩れがないか（iPhoneサイズ）確認

## 14. ログ / 監視
- 収集失敗ログ（URL、理由、時刻）
- 処理時間ログ（取得→抽出→イラスト化）
- APIエラーログ（検索・詳細取得）
- 監視アラート: 失敗率、処理時間の閾値超過

### 14.1 監視閾値（初期値）
- 収集失敗率 >= 10% が連続2回でアラート
- 1件あたり処理時間 >= 30秒が5件連続でアラート
- 色検索APIの5xx >= 1% / 1時間でアラート

## 15. テスト / 品質保証
- 色抽出の精度検証（目視サンプルレビュー）
- APIレスポンスのスキーマチェック
- 画面表示の回帰テスト（iPhoneサイズ）

## 16. 評価指標（KPI）
- 検索利用率（色検索/カテゴリ検索）
- コーデ閲覧数、保存数
- 色相性ペアのクリック率

## 17. リスクと対策
- **著作権リスク**: イラスト化運用＋元画像の非公開
- **品質リスク**: 色抽出ミス → 手動補正機能
- **データ偏り**: 取得元サイト依存 → 複数ソース化

## 18. マイルストーン（例）
- **MVP**: 収集→イラスト化→色検索・カテゴリ検索
- **β**: ルール拡充、検索精度改善、UI調整
- **正式**: 取得ソース拡大、運用安定化

### 18.1 MVPスコープ詳細
- 収集パイプライン（手動実行）
- イラスト化 + 色抽出
- 色検索（近似色 + 相性色）
- カテゴリ検索
- コーデ詳細
- 管理画面（収集/補正/ログ）

## 19. 次のブラッシュアップ候補
1. **シルエット化処理の具体手法**（ポスタライズ/色抽出ルール）
2. **色抽出のアルゴリズム選定**（K-means / 主色抽出）
3. **色相性ルールの拡充**（ユーザー評価反映）
4. **カテゴリ体系の詳細設計**
